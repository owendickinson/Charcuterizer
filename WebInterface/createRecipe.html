<html>

<head>
  <title>Charcuterizer Recipe Creator</title>

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/dark-hive/jquery-ui.css">
  <link rel="stylesheet" href="charcuterizer.css">

  <script src="https://raw.githubusercontent.com/github/fetch/master/fetch.js"></script>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script type='text/javascript'>

  var recipeForm;

  $( window ).on('load', function(){
    recipeForm = new RecipeForm;
  });

  class RecipeStage {

    constructor(){
      this.columnNames = [ 'Stage', 'Duration (days)',	'Min. Temp. (C)',	'Max. Temp. (C)',	'Min. Hum. (%)',	'Max. Hum. (%)' ]
      this.inputNames = ['durationDays', 'minTempC', 'maxTempC', 'minHumPc', 'maxHumPc'];
      this.inputTypes = ['number', 'number', 'number', 'number', 'number'];
      this.inputRanges = [[1, 365], [0, 70], [0, 70], [0, 100], [0, 100]];
    }

    genHeaderRow(){
      var row = $("<thead/>",{
        "class" : "ui-widget-header"
      });

      for(var columnName of this.columnNames){
        $("<td/>",{
          'class' : 'generalTableCell',
          "text" : columnName
        }).appendTo(row);
      }
      return row;
    }

    genStageRow(stage){
      var row = $('<tr/>');
      $('<td/>').text(stage).appendTo(row);

      for(var iField=0; iField < this.inputNames.length; iField++){
        var field = $("<td/>",{
          'class' : 'generalTableCell'
        });
        $('<input/>', {
          'name' : this.inputNames[iField] + '[' + String(stage-1) + ']',
          'type' : this.inputTypes[iField],
          'min' : this.inputRanges[iField][0],
          'max' : this.inputRanges[iField][1],
          'width' : '100%'
        }).appendTo(field);
        field.appendTo(row);
      }
      return row;
    }

  }

  class RecipeForm {

    constructor (){
      this.recipeStageGenerator = new RecipeStage;
      this.numStages = 1
      this.addTableHeader();
      this.addNewStage(this.numStages);
    }

    addTableHeader(){
      this.recipeStageGenerator.genHeaderRow().appendTo($('#stagesTable'));
    }

    addNewStage(){
      this.recipeStageGenerator.genStageRow(this.numStages).appendTo($('#stagesTableBody'));
      this.numStages++;
    }

  }

  function saveNewRecipe() {
    fetch('databaseInterface.php', {
      method: 'POST',
      body: new FormData(document.getElementById('recipeForm')),
      mode: 'same-origin',
      redirect: 'follow'
    }).then(function(promisedResponse) {
      return promisedResponse.text();
    }).then(function(responseText){
      console.log(responseText);
      $('<div/>', {
        'id' :'recipeSummary'
      }).html(responseText).addClass('modalDiv').appendTo($('body'));
    }).catch(function(){
      console.log('Caught error!');
    });
  }

  function addNewStage(){
    recipeForm.addNewStage();
  }

  function dismissModal(){
    $('#recipeSummary').remove();
  }

  </script>

</head>

<body class="ui-widget">

  <h1>Charcuterizer Recipe Creator</h1>
  <div id='contentDiv'>
    <form id='recipeForm'>
      <div class='recipeFormControls'>
        <input type='text' name='recipeName' placeholder='Recipe Name' class='ui-widget' required/>
        <button type='button' name='saveRecipe' value='saveRecipe' onclick='saveNewRecipe()' class='ui-button'>Save Recipe</button>
        <button type='button' name='addStage' value='addNewStage' onclick='addNewStage()' class='ui-button'>Add New Stage</button>
      </div>
      <table id='stagesTable' class='ui-widget generalTable'>
        <tbody class="ui-widget-content" id='stagesTableBody'>
        </tbody>
      </table>

    </form>
  </div>
</body>

</html>
